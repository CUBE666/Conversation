<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>会話プログラム</title>
<link rel="stylesheet" href="style.css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<meta http-equiv="Content-type" content="text/html; charset=UTF-8">
</head>
<body>
<form name="text">
<p>
<textarea name="skit"></textarea><br>
<input type="text" name="choice1" onclick="answer(1)">
<input type="text" name="choice2" onclick="answer(2)">
<input type="text" name="choice3" onclick="answer(3)">
</p>
</form>

<script type="text/javascript">
window.onload = init;
var numChoice = 3;			// 選択肢数
var numConversation = 3;	// 会話数
// テキストボックス反映用変数
var skitBox, choice1Box, choice2Box, choice3Box;
// 会話データ格納用変数(skit:会話内容、c1～c3:選択肢)
var skit, c1, c2, c3;
var conversationData;	// 会話データ(csv形式)
// 選択した選択肢を記録する配列
var skitData = new Array(numConversation);
var skitNumber;			// 現在の会話の番号

function init() {
	skitNumber = 0;	// 会話番号を0で初期化
	conversationData = csv2Array("text.csv"); // csvファイル読み込み
	
	// テキストボックスに反映するための準備
	skitBox = document.text.skit;
	choice1Box = document.text.choice1;
	choice2Box = document.text.choice2;
	choice3Box = document.text.choice3;
	
	// 最初の会話データを読み込む
	skit = conversationData[0][0];
	c1 = conversationData[0][1];
	c2 = conversationData[0][2];
	c3 = conversationData[0][3];
	
	// テキストボックスに内容を反映
	skitBox.value = skit;
	choice1Box.value = c1;
	choice2Box.value = c2;
	choice3Box.value = c3;
}

function csv2Array(filePath) { //csvファイルの相対パスor絶対パス
	var csvData = new Array();
	var data = new XMLHttpRequest();	
	data.open("GET", filePath, false); //true:非同期,false:同期
	data.send(null);

	var LF = "\n"; //改行コード
	var lines = data.responseText.split(LF);
	for (var i = 0; i < lines.length;++i) {
		var cells = lines[i].split(",");
		if( cells.length != 1 ) {
			csvData.push(cells);
		}
	}
	return csvData;
}

// 選択肢を選んだときの処理の関数
function answer(ans) {
	// 今までの答えから次の会話と選択肢を設定
	var temp = 0;
	for (var i = 0; i < skitNumber; i++) {
		temp += skitData[i] * power(numChoice, skitNumber - i);
	}
	temp += ans;
	
	// 会話がまだ残っていれば次へ
	if (skitNumber < numConversation - 1) {
		// 会話データを読み込み
		skit = conversationData[temp][0];
		c1 = conversationData[temp][1];
		c2 = conversationData[temp][2];
		c3 = conversationData[temp][3];
		skitData[skitNumber] = ans;
		skitNumber++;
	}
	else {
		// 会話終了
		skit = conversationData[temp][0];
		c1 = "";
		c2 = "会話は終了です";
		c3 = "";
	}
		
	// 会話データをテキストボックスに反映
	skitBox.value = skit;
	choice1Box.value = c1;
	choice2Box.value = c2;
	choice3Box.value = c3;
}

// aのr乗を求める関数
function power(a, r) {
	var num = 1;
	for (var i = 0; i < r; i++) {
		num *= a;
	}
	return num;
}
</script>
</body>
</html>